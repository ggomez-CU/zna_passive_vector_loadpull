name: test_DMM
requires: [DMM1, DMM2]

plot:
  type: grid
  rows: 1
  cols: 3
  panels:
    - {title: "Both", x: "sample", y: ["Vdc1","Vdc2"], refresh: False}
    - {title: "DMM1", x: "sample", y: "Vdc1", refresh: False}
    - {title: "DMM2", x: "sample", y: "Vdc2", refresh: False}

steps:
  - call: {inst: DMM1, method: preset}
  - call: {inst: DMM1, method: configure_voltage_dc}
  - call: {inst: DMM2, method: preset}
  - call: {inst: DMM2, method: configure_voltage_dc}
  - sweep:
      var: sample
      from: 1
      to:   30
      step: 1
      do:
        - measure: {inst: DMM1, method: measure_voltage, save_as: Vdc1}
        - measure: {inst: DMM2, method: measure_voltage, save_as: Vdc2}
        - results_update: {}


do:
- sweep:
  var: sample
  from: 1
  to: 100
  step: 1
  do:
  - measure: {inst: DMM1, method: measure_voltage, save_as: Vdc1}
  - transform:
      method: running_std_update
      args: { value: ${Vdc1.Vdc}, state: ${cal.noise_state} }
      save_as: cal.noise_state
- transform:
    method: running_std_finalize
    args: { state: ${cal.noise_state} }
    save_as: cal.noise
- results_update:
  step: "cal:dmm1_noise_std"
  extra: { std: ${cal.noise.std}, count: ${cal.noise.count} }
  save: ${cal.noise.std}