name: test_TUNERS
requires: [LOADTUNER, SOURCETUNER]

parameters: {freq_ghz: {default: 5}, sweep_file: {default: "loadsweeps/test_Tuner_sweep.csv"}}

plot:
  type: grid
  rows: 1
  cols: 3
  panels:
    - { title: "Expected", x: "gamma.angle_rad", y: "gamma.mag", polar: true, refresh: false }
    - { title: "Load Position", x: "loadposition.x",y: ["loadposition.y_low","loadposition.y_high"], polar: False, refresh: False }
    - { title: "Source Position", x: "sourceposition.x",y: ["sourceposition.y_low","sourceposition.y_high"], polar: False, refresh: False }

steps:
  - call: {inst: LOADTUNER, method: preset}
  - call: {inst: SOURCETUNER, method: preset}
  - measure: {inst: LOADTUNER, method: config_info, save_as: loadtuner_config}
  - measure: {inst: SOURCETUNER, method: config_info, save_as: sourcetuner_config}
  - measure: {inst: SOURCETUNER, method: pos, save_as: sourceposition}
  - measure: {inst: LOADTUNER, method: pos, save_as: loadposition}
  - results_update: {}
  - call: {inst: SOURCETUNER, method: move_axis, args: ["x", 100]}
  - call: {inst: SOURCETUNER, method: move_axis, args: ["y_low", 100]}
  - call: {inst: SOURCETUNER, method: move_axis, args: ["y_high", 100]}
  - measure: {inst: SOURCETUNER, method: pos, save_as: sourceposition}
  - results_update: {}
  - call: {inst: LOADTUNER, method: move_axis, args: ["x", 100]}
  - call: {inst: LOADTUNER, method: move_axis, args: ["y_low", 100]}
  - call: {inst: LOADTUNER, method: move_axis, args: ["y_high", 100]}
  - measure: {inst: LOADTUNER, method: pos, save_as: loadposition}
  - results_update: {}
  - call: {inst: LOADTUNER, method: set_impedance, args: [1, 25, -25]}
  - call: {inst: SOURCETUNER, method: set_impedance, args: [1, 25, -25]}
  - transform: {method: z2gamma, args: {"real": 25, "imag":-25}, save_as: gamma}
  - measure: {inst: LOADTUNER, method: pos, save_as: loadposition}
  - measure: {inst: SOURCETUNER, method: pos, save_as: sourceposition}
  - results_update: {}
  - call: {inst: LOADTUNER, method: set_gamma, args: [5, .1, -25]}
  - call: {inst: SOURCETUNER, method: set_gamma, args: [5, .1, -25]}
  - transform: {method: set_plot_gamma, args: {"mag": .1, "deg":-25}, save_as: gamma}
  - measure: {inst: LOADTUNER, method: pos, save_as: loadposition}
  - measure: {inst: SOURCETUNER, method: pos, save_as: sourceposition}
  - results_update: {}
  - transform: {
      method: load_sweep_len,
      args: { file: "${sweep_file}" },
      save_as: "sweep_info"}
  - sweep:
      var: idx
      from: 0
      to: "${sweep_info.count}"
      step: 1
      do:
        - transform: {
            method: load_sweep_point,
            args: { file: "${sweep_file}", index: "${idx}" },
            save_as: "point"}
        - call: { inst: LOADTUNER, method: set_gamma, args: ["${freq_ghz}", "${point.gamma_mag}", "${point.gamma_deg}"] }
        - call: { inst: SOURCETUNER, method: set_gamma, args: ["${freq_ghz}", "${point.gamma_mag}", "${point.gamma_deg}"] }
        - measure: {inst: LOADTUNER, method: pos, save_as: loadposition}
        - measure: {inst: SOURCETUNER, method: pos, save_as: sourceposition}
        - transform: {method: set_plot_gamma, args: {"mag":"${point.gamma_mag}", "deg":"${point.gamma_deg}"}, save_as: gamma}
        - results_update: {}

