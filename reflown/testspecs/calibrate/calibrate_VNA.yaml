name: calibrate_VNA
requires: [VNA]

parameters: {cal_filename: {default: "20251029_2portPVR_2.cal"}, setup_filename: {default: "PassiveLoadpullCalState.zvx"}}

plot:
  type: grid
  rows: 1
  cols: 2
  panels:
    - { title: "Error Terms Real", 
      x: "error_data.freq.x_data",
      y: ["error_data.directivity_input.real",
            "error_data.srcmatch_input.real",
            "error_data.refltrack_input.real",
            "error_data.loadmatch_input.real",
            "error_data.transtrack_input2output.real",
            "error_data.directivity_output.real",
            "error_data.srcmatch_output.real",
            "error_data.refltrack_output.real",
            "error_data.loadmatch_output.real",
            "error_data.transtrack_output2input.real"],
      polar: false, 
      refresh: true }

    - { title: "Error Terms Imag", 
      x: "error_data.freq.x_data",
      y: ["error_data.directivity_input.imag",
            "error_data.srcmatch_input.imag",
            "error_data.refltrack_input.imag",
            "error_data.loadmatch_input.imag",
            "error_data.transtrack_input2output.imag",
            "error_data.directivity_output.imag",
            "error_data.srcmatch_output.imag",
            "error_data.refltrack_output.imag",
            "error_data.loadmatch_output.imag",
            "error_data.transtrack_output2input.imag"],
      polar: false, 
      refresh: true }

steps:
  - calibrate:
      name: error_terms
      force: true
      do:
        - call: {inst: VNA, method: clear_syserror}
        - call: {inst: VNA, method: load_setup, args: ["${setup_filename}"]}
        - measure: {inst: VNA, method: get_error_terms, args: ["${cal_filename}"], save_as: error_data} 
      save: ${error_data}
  - results_update: {}
